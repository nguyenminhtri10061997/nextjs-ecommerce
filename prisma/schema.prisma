datasource db {
    provider = "postgresql"
    url      = env("POSTGRES_URL")
}

generator client {
    provider = "prisma-client-js"
}

generator zod {
    provider = "prisma-zod-generator"
    output   = "./generated"
    config   = "./zod-generator.config.json"
}

// AUTH SERVICE

enum EUserOrAccountType {
    CUSTOMER
    STAFF
}

enum EPermissionAction {
    READ
    CREATE
    UPDATE
    DELETE
}

enum EPermissionResource {
    USER
    ROLE
    PERMISSION
    PRODUCT
    BRAND
    LANGUAGE
    PRODUCT_CATEGORY
    ATTRIBUTE
    OPTION
    PRODUCT_STATUS
    PRODUCT_RATING
    PRODUCT_TAG
}

// Tables

model User {
    id            String             @id @default(uuid())
    fullName      String
    type          EUserOrAccountType
    account       Account?
    createdAt     DateTime           @default(now())
    updatedAt     DateTime           @default(now()) @updatedAt
    productRating ProductRating[]
}

model Account {
    id                 String             @id @default(uuid())
    username           String             @unique
    password           String
    type               EUserOrAccountType
    accessTokenVersion Int                @default(1)
    isBanned           Boolean            @default(false)
    isBlocked          Boolean            @default(false)
    userId             String             @unique
    roleId             String
    createdAt          DateTime           @default(now())
    updatedAt          DateTime           @default(now()) @updatedAt

    role         Role           @relation(fields: [roleId], references: [id])
    user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
    refreshToken RefreshToken[]
}

model Role {
    id          String   @id @default(uuid())
    name        String   @unique
    description String?
    createdAt   DateTime @default(now())
    updatedAt   DateTime @default(now()) @updatedAt

    accounts    Account[]
    permissions Permission[]
}

model Permission {
    id        String              @id @default(uuid())
    resource  EPermissionResource
    action    EPermissionAction
    createdAt DateTime            @default(now())
    updatedAt DateTime            @default(now()) @updatedAt

    role Role[]

    @@unique([action, resource], name: "action_resource")
}

model RefreshToken {
    id        String   @id @default(uuid())
    token     String
    expiresAt DateTime
    ipAddress String
    userAgent String
    accountId String
    createdAt DateTime @default(now())
    updatedAt DateTime @default(now()) @updatedAt

    account Account @relation(fields: [accountId], references: [id])
}

// PRODUCT SERVICE

enum EStockStatus {
    STOCKING
    OUT_OF_STOCK
    ALMOST_OUT_OF_STOCK
}

enum EStockType {
    INVENTORY // => stock && has skuAttributeValues
    // EXTERNAL
    ATTRIBUTE // => stock
    DIGITAL // => downloadUrl
    MANUAL // => stockStatus
}

enum EPriceModifierType {
    FREE // free
    ADD // add more money of price
    SUBTRACT // subtract money of price (very rare but example: don't want get plastic eating utensils)
    SET // set price again
    PERCENT // add price by percent %
    REDUCE_PERCENT // reduce price by percent %
}

enum ETagDisplayType {
    TEXT_IMAGE
    IMAGE_ONLY
    TEXT_BACKGROUND
}

enum EOptionContext {
    PRODUCT
    //   ORDER
    //   GIFT
    //   SHIPPING
}

enum EProductType {
    SIMPLE
    VARIABLE
    DIGITAL
    SERVICE
}

enum ESkuStatus {
    ACTIVE
    // INACTIVE_BY_SYSTEM
    INACTIVE_BY_ADMIN
    DELETED
}

enum EAttributeStatus {
    ACTIVE
    // INACTIVE_BY_SYSTEM
    INACTIVE_BY_ADMIN
    DELETED
}

enum EAttributeValueStatus {
    ACTIVE
    // INACTIVE_BY_SYSTEM
    INACTIVE_BY_ADMIN
    DELETED
}

enum EAttributeType {
    RADIO
    COLOR
}

// Tables

model Product {
    id                String       @id @default(uuid())
    productCategoryId String?
    brandId           String?
    code              String       @unique
    name              String       @unique
    slug              String       @unique
    seoTitle          String?
    description       String?
    seoDescription    String?
    detail            String?
    mainImage         String
    listImages        String[]     @default([])
    viewCount         Int          @default(0)
    soldCount         Int          @default(0)
    type              EProductType
    isDeleted         Boolean      @default(false)
    avgRateBySystem   Float?
    avgRateByAdmin    Float?
    isActive          Boolean      @default(true)
    createdAt         DateTime     @default(now())
    updatedAt         DateTime     @default(now()) @updatedAt

    productAttributes    ProductAttribute[]
    productSkus          ProductSku[]
    productTranslations  ProductTranslation[]
    productRatings       ProductRating[]
    productToProductTags ProductToProductTag[]
    productOptions       ProductOption[]
    productCategory      ProductCategory?      @relation(fields: [productCategoryId], references: [id])
    brand                Brand?                @relation(fields: [brandId], references: [id])
}

model Brand {
    id        String    @id @default(uuid())
    name      String    @unique
    slug      String?   @unique
    logoImage String?
    isActive  Boolean   @default(true)
    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
    products  Product[]
}

model Language {
    id        String   @id @default(uuid())
    code      String   @unique
    name      String   @unique
    isActive  Boolean  @default(true)
    isDefault Boolean? @default(false)
    createdAt DateTime @default(now())
    updatedAt DateTime @default(now()) @updatedAt

    productCategoryTranslations ProductCategoryTranslation[]
    productTranslations         ProductTranslation[]
}

model ProductCategory {
    id                      String            @id @default(uuid())
    name                    String            @unique
    slug                    String?           @unique
    seoTitle                String?
    description             String?
    seoDescription          String?
    displayOrder            Int?
    productCategoryParentId String?
    ProductCategoryParent   ProductCategory?  @relation("ProductCategories", fields: [productCategoryParentId], references: [id])
    ProductCategoryChilds   ProductCategory[] @relation("ProductCategories")
    isActive                Boolean           @default(true)
    createdAt               DateTime          @default(now())
    updatedAt               DateTime          @default(now()) @updatedAt

    products     Product[]
    translations ProductCategoryTranslation[]
}

model ProductCategoryTranslation {
    id                String   @id @default(uuid())
    productCategoryId String
    languageId        String
    name              String
    seoTitle          String
    description       String
    seoDescription    String
    createdAt         DateTime @default(now())
    updatedAt         DateTime @default(now()) @updatedAt

    productCategory ProductCategory @relation(fields: [productCategoryId], references: [id])
    language        Language        @relation(fields: [languageId], references: [id])
}

model ProductTranslation {
    id             String   @id @default(uuid())
    productId      String
    languageId     String
    name           String   @unique
    slug           String?  @unique
    seoTitle       String?
    description    String?
    seoDescription String?
    detail         String?
    createdAt      DateTime @default(now())
    updatedAt      DateTime @default(now()) @updatedAt

    product  Product  @relation(fields: [productId], references: [id])
    language Language @relation(fields: [languageId], references: [id])
}

model Attribute {
    id               String             @id @default(uuid())
    name             String             @unique
    slug             String?            @unique
    displayOrder     Int?
    type             EAttributeType
    createdAt        DateTime           @default(now())
    updatedAt        DateTime           @default(now()) @updatedAt
    attributeValues  AttributeValue[]
    ProductAttribute ProductAttribute[]
}

model AttributeValue {
    id           String   @id @default(uuid())
    name         String
    slug         String?
    displayOrder Int?
    createdAt    DateTime @default(now())
    updatedAt    DateTime @default(now()) @updatedAt

    attributeId           String
    attribute             Attribute               @relation(fields: [attributeId], references: [id])
    ProductAttributeValue ProductAttributeValue[]

    @@unique([attributeId, name], name: "attributeId_name_unique")
}

model ProductAttribute {
    id                  String           @id @default(uuid())
    productId           String
    attributeId         String
    status              EAttributeStatus
    isUsedForVariations Boolean?
    displayOrder        Int?
    createdAt           DateTime         @default(now())
    updatedAt           DateTime         @default(now()) @updatedAt

    product                  Product                    @relation(fields: [productId], references: [id])
    attribute                Attribute                  @relation(fields: [attributeId], references: [id])
    productAttributeValues   ProductAttributeValue[]
    productSkuAttributeValue ProductSkuAttributeValue[]
}

model ProductAttributeValue {
    id                 String                @id @default(uuid())
    productAttributeId String
    attributeValueId   String
    image              String?
    displayOrder       Int?
    status             EAttributeValueStatus
    createdAt          DateTime              @default(now())
    updatedAt          DateTime              @default(now()) @updatedAt

    productAttribute         ProductAttribute           @relation(fields: [productAttributeId], references: [id])
    attributeValue           AttributeValue             @relation(fields: [attributeValueId], references: [id])
    productSkuAttributeValue ProductSkuAttributeValue[]
}

model ProductSku {
    id           String        @id @default(uuid())
    productId    String
    sellerSku    String?
    stockStatus  EStockStatus?
    stockType    EStockType
    image        String?
    salePrice    Float?
    price        Float
    costPrice    Float?
    stock        Int?
    downloadUrl  String?
    note         String?
    barcode      String?
    weight       Float?
    width        Float?
    height       Float?
    length       Float?
    displayOrder Int?
    isDefault    Boolean?
    status       ESkuStatus
    createdAt    DateTime      @default(now())
    updatedAt    DateTime      @default(now()) @updatedAt

    product            Product                    @relation(fields: [productId], references: [id])
    skuAttributeValues ProductSkuAttributeValue[]
}

model ProductSkuAttributeValue {
    id                      String   @id @default(uuid())
    productSkuId            String
    productAttributeId      String
    productAttributeValueId String
    createdAt               DateTime @default(now())
    updatedAt               DateTime @default(now()) @updatedAt

    productSku            ProductSku            @relation(fields: [productSkuId], references: [id])
    productAttribute      ProductAttribute      @relation(fields: [productAttributeId], references: [id])
    productAttributeValue ProductAttributeValue @relation(fields: [productAttributeValueId], references: [id])

    @@unique([productSkuId, productAttributeValueId], name: "productSkuId_productAttributeValueId")
}

model Option {
    id           String         @id @default(uuid())
    name         String         @unique
    slug         String?        @unique
    displayOrder Int?
    isActive     Boolean        @default(true)
    context      EOptionContext
    createdAt    DateTime       @default(now())
    updatedAt    DateTime       @default(now()) @updatedAt

    optionItems   OptionItem[]
    ProductOption ProductOption[]
}

model OptionItem {
    id           String   @id @default(uuid())
    optionId     String
    name         String
    slug         String?
    displayOrder Int?
    isActive     Boolean  @default(true)
    createdAt    DateTime @default(now())
    updatedAt    DateTime @default(now()) @updatedAt

    Option                    Option                      @relation(fields: [optionId], references: [id])
    ProductOptionToOptionItem ProductOptionToOptionItem[]

    @@unique([optionId, name], name: "optionId_name")
    @@unique([optionId, slug], name: "optionId_slug")
}

model ProductOption {
    id           String   @id @default(uuid())
    productId    String
    optionId     String
    displayOrder Int?
    isRequired   Boolean  @default(false)
    maxSelect    Int?
    createdAt    DateTime @default(now())
    updatedAt    DateTime @default(now()) @updatedAt

    product                   Product                     @relation(fields: [productId], references: [id])
    option                    Option                      @relation(fields: [optionId], references: [id])
    ProductOptionToOptionItem ProductOptionToOptionItem[]

    @@unique([productId, optionId])
}

model ProductOptionToOptionItem {
    id                 String             @id @default(uuid())
    productOptionId    String
    optionItemId       String
    displayOrder       Int?
    priceModifierType  EPriceModifierType
    priceModifierValue Float
    createdAt          DateTime           @default(now())
    updatedAt          DateTime           @default(now()) @updatedAt

    optionItem    OptionItem    @relation(fields: [optionItemId], references: [id])
    productOption ProductOption @relation(fields: [productOptionId], references: [id])

    @@unique([productOptionId, optionItemId])
}

model ProductTag {
    id               String          @id @default(uuid())
    code             String          @unique
    name             String          @unique
    slug             String?         @unique
    description      String?
    expiredAfterDays Int?
    displayType      ETagDisplayType
    image            String?
    bgColor          String?
    textColor        String?
    displayOrder     Int?
    isActive         Boolean         @default(true)
    createdAt        DateTime        @default(now())
    updatedAt        DateTime        @default(now()) @updatedAt

    products ProductToProductTag[]
}

model ProductToProductTag {
    id           String    @id @default(uuid())
    productId    String
    productTagId String
    expiredAt    DateTime?
    createdAt    DateTime  @default(now())
    updatedAt    DateTime  @default(now()) @updatedAt

    product    Product    @relation(fields: [productId], references: [id])
    productTag ProductTag @relation(fields: [productTagId], references: [id])

    @@unique([productId, productTagId])
}

model ProductRating {
    id             String   @id @default(uuid())
    userId         String
    productId      String
    rating         Float
    title          String
    detail         String
    video          String?
    images         String[] @default([])
    isVerify       Boolean  @default(false)
    verifyByUserId String?
    createdAt      DateTime @default(now())
    updatedAt      DateTime @default(now()) @updatedAt

    product Product @relation(fields: [productId], references: [id])
    user    User    @relation(fields: [userId], references: [id])

    @@unique([productId, userId])
}

model RetryError {
    id        String   @id @default(cuid())
    createdAt DateTime @default(now())
    retryKey  String? // for group 1 api retry => support onFinalRetry
    funcName  String?
    args      Json?
    message   String?
    stack     String?
    metadata  Json?
}
